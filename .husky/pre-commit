#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running enhanced pre-commit quality checks..."

# Check if this is a documentation-only commit
DOCS_ONLY=$(git diff --cached --name-only | grep -E '\.(md|txt|json|yml|yaml)$' | wc -l)
TOTAL_FILES=$(git diff --cached --name-only | wc -l)

# If only documentation files are changed, skip heavy checks
if [ "$DOCS_ONLY" -eq "$TOTAL_FILES" ] && [ "$TOTAL_FILES" -gt 0 ]; then
  echo "ğŸ“ Documentation-only commit detected - running light checks..."

  # Check markdown formatting
  if command -v markdownlint >/dev/null 2>&1; then
    npx markdownlint --fix *.md 2>/dev/null || echo "âš ï¸  Markdown linting not available"
  fi

  # Check for sensitive data in docs
  if command -v trufflehog >/dev/null 2>&1; then
    trufflehog filesystem --directory=. --fail --no-update 2>/dev/null || echo "âš ï¸  Secret scanning not available"
  fi

  echo "âœ… Documentation checks passed"
  exit 0
fi

# Run strict TypeScript validation
echo "ğŸ”· Running strict TypeScript validation..."
npx tsc --noEmit --strict || {
  echo "âŒ Strict TypeScript validation failed"
  echo "ğŸ’¡ Fix TypeScript compilation errors before committing"
  echo "   Run 'npx tsc --noEmit --strict' to see the full error details"
  exit 1
}

# Run ESLint on staged files with strict rules
echo "ğŸ”§ Running ESLint on staged files..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|ts|tsx|mjs|cjs)$' | tr '\n' ' ')

if [ -n "$STAGED_FILES" ]; then
  npx eslint $STAGED_FILES --max-warnings 0 || {
    echo "âŒ ESLint found issues in staged files"
    echo "ğŸ’¡ Fix the linting errors before committing"
    echo "   Run 'npx eslint $STAGED_FILES --fix' to auto-fix many issues"
    exit 1
  }
fi

# Run security-focused ESLint
echo "ğŸ”’ Running security ESLint..."
npx eslint src --ext .ts --config eslint.security.config.cjs --max-warnings 0 || {
  echo "âŒ Security ESLint found issues"
  echo "ğŸ’¡ Fix security issues before committing"
  exit 1
}

# Check code formatting
echo "ğŸ¨ Checking code formatting..."
npm run format:check || {
  echo "âŒ Code formatting issues found"
  echo "ğŸ’¡ Run 'npm run format' to fix formatting issues"
  exit 1
}

# Run MCP Inspector validation if MCP files changed
MCP_FILES_CHANGED=$(git diff --cached --name-only | grep -E '\.(mcp|mcp\.json|index\.ts|.*mcp.*)$' | wc -l)

if [ "$MCP_FILES_CHANGED" -gt 0 ]; then
  echo "ğŸ”Œ Running MCP-specific validation..."

  # Basic MCP schema validation
  if [ -f "test-mcp-simple.cjs" ]; then
    timeout 30 node test-mcp-simple.cjs || {
      echo "âŒ MCP validation failed"
      echo "ğŸ’¡ Fix MCP implementation issues before committing"
      exit 1
    }
  fi

  # MCP Protocol compliance check
  if [ -f "test-mcp-comprehensive.cjs" ]; then
    timeout 60 node test-mcp-comprehensive.cjs || {
      echo "âš ï¸  MCP compliance issues detected"
      echo "ğŸ’¡ Review MCP protocol implementation"
    }
  fi

  # Run MCP Inspector tests if available
  if [ -f "scripts/run-mcp-inspector-tests.js" ]; then
    timeout 120 node scripts/run-mcp-inspector-tests.js || {
      echo "âš ï¸  MCP Inspector tests failed"
      echo "ğŸ’¡ Fix MCP Inspector compliance issues"
    }
  fi
fi

# Run tests related to changed files
echo "ğŸ§ª Running relevant tests..."
CHANGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.ts$' | wc -l)

if [ "$CHANGED_TS_FILES" -gt 0 ]; then
  # Run a subset of tests focused on changed areas
  if command -v vitest >/dev/null 2>&1; then
    timeout 120 npm run test:unit || timeout 120 npm test || {
      echo "âŒ Tests failed"
      echo "ğŸ’¡ Fix failing tests before committing"
      echo "   Run 'npm test' to see full test results"
      exit 1
    }
  else
    echo "âš ï¸  Test runner not available, skipping tests"
  fi
fi

# Run security audit on dependencies if package.json changed
if git diff --cached --name-only | grep -q 'package.json'; then
  echo "ğŸ”’ Running security audit on dependencies..."
  timeout 60 npm audit --audit-level=moderate || {
    AUDIT_STATUS=$?
    if [ $AUDIT_STATUS -gt 1 ]; then
      echo "âŒ Critical/High security vulnerabilities found"
      echo "ğŸ’¡ These must be fixed before committing"
      echo "   Run 'npm audit fix' to resolve vulnerabilities"
      exit 1
    else
      echo "âš ï¸  Moderate security vulnerabilities found"
      echo "ğŸ’¡ Consider running 'npm audit fix' to resolve vulnerabilities"
    fi
  }
fi

# Check for potential secrets in staged files
echo "ğŸ” Checking for potential secrets..."
STAGED_CONTENT=$(git diff --cached --name-only | xargs cat 2>/dev/null | grep -iE '(password|secret|key|token|api[_-]?key|private[_-]?key)' | head -5)

if [ -n "$STAGED_CONTENT" ]; then
  echo "âš ï¸  Potential secrets detected in staged files:"
  echo "$STAGED_CONTENT"
  echo ""
  echo "ğŸ’¡ Please ensure no secrets are committed to the repository"
  echo "   If these are false positives, you can continue with 'git commit --no-verify'"
  read -p "Continue anyway? (y/N): " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
fi

# Check file sizes
echo "ğŸ“ Checking file sizes..."
LARGE_FILES=$(git diff --cached --name-only | xargs ls -la 2>/dev/null | awk '$5 > 1048576 {print $9 " (" $5/1024/1024 "MB)"}' | head -3)

if [ -n "$LARGE_FILES" ]; then
  echo "âš ï¸  Large files detected in commit:"
  echo "$LARGE_FILES"
  echo ""
  echo "ğŸ’¡ Consider using Git LFS or breaking down large files"
  read -p "Continue anyway? (y/N): " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
fi

# Run production readiness validation if deployment files changed
DEPLOY_FILES_CHANGED=$(git diff --cached --name-only | grep -E '\.(docker|docker-compose|k8s|helm|deployment)$' | wc -l)

if [ "$DEPLOY_FILES_CHANGED" -gt 0 ]; then
  echo "ğŸš€ Validating production readiness..."

  # Check Docker configuration
  if [ -f "docker/Dockerfile" ]; then
    docker --version >/dev/null 2>&1 && docker build -t test-build docker/ >/dev/null 2>&1 || {
      echo "âš ï¸  Docker build validation failed"
      echo "ğŸ’¡ Check Docker configuration"
    }
  fi

  # Check environment variables template
  if [ ! -f ".env.example" ]; then
    echo "âš ï¸  Missing .env.example template"
    echo "ğŸ’¡ Create .env.example with required environment variables"
  fi
fi

# Run final quality gate validation
echo "ğŸ¯ Running final quality gate validation..."
timeout 180 node scripts/quality-gate-enforcer.js --quick-check || {
  echo "âŒ Quality gate validation failed"
  echo "ğŸ’¡ Fix quality issues before committing"
  echo "   Run 'npm run quality-gate:enforce' for detailed validation"
  exit 1
}

echo "âœ… All pre-commit quality checks passed!"
echo "ğŸ‰ Ready to commit changes"
echo ""
echo "ğŸ“Š Quality Summary:"
echo "  â€¢ TypeScript: âœ… Strict validation passed"
echo "  â€¢ ESLint: âœ… Linting passed"
echo "  â€¢ Security: âœ… Security checks passed"
echo "  â€¢ Tests: âœ… Tests passed"
echo "  â€¢ MCP: $([ "$MCP_FILES_CHANGED" -gt 0 ] && echo "âœ… MCP validation passed" || echo "â„¹ï¸  No MCP changes")"
echo "  â€¢ Production: $([ "$DEPLOY_FILES_CHANGED" -gt 0 ] && echo "âœ… Production checks passed" || echo "â„¹ï¸  No deployment changes")"
