#!/bin/sh

echo "ğŸ” Running pre-commit gate sequence..."

# Gate 1: Type checking
echo "ğŸ“ Gate 1: Type checking..."
TYPE_OUTPUT=$(npm run type-check 2>&1)
TYPE_EXIT_CODE=$?
if [ $TYPE_EXIT_CODE -ne 0 ]; then
    echo "âŒ Type checking failed - Fix Plan:"
    echo "   1. Check TypeScript errors in output above"
    echo "   2. Fix type annotations, missing imports, or interface mismatches"
    echo "   3. Run 'npm run type-check' to verify fixes"
    echo "   âŒ STOPPED: Type checking must pass before proceeding"
    exit 1
fi
echo "âœ… Type checking passed"

# Gate 2: Linting
echo "ğŸ§¹ Gate 2: Linting..."
npm run lint
if [ $? -ne 0 ]; then
    echo "âŒ Linting failed - Fix Plan:"
    echo "   1. Check ESLint errors in output above"
    echo "   2. Fix unused variables, missing semicolons, quote styles"
    echo "   3. Run 'npm run lint:fix' for auto-fixable issues"
    echo "   4. Run 'npm run lint' to verify fixes"
    echo "   âŒ STOPPED: Linting must pass before proceeding"
    exit 1
fi
echo "âœ… Linting passed"

# Gate 3: Format/Imports checking
echo "âœ¨ Gate 3: Format and Imports checking..."
npm run format:check
if [ $? -ne 0 ]; then
    echo "âŒ Format checking failed - Fix Plan:"
    echo "   1. Run 'npm run format' to auto-fix formatting issues"
    echo "   2. Check import ordering and consistency"
    echo "   3. Run 'npm run lint:imports' to check import order"
    echo "   4. Run 'npm run format:check' to verify fixes"
    echo "   âŒ STOPPED: Formatting must pass before proceeding"
    exit 1
fi

npm run lint:imports
if [ $? -ne 0 ]; then
    echo "âŒ Import checking failed - Fix Plan:"
    echo "   1. Check import order violations in output above"
    echo "   2. Reorder imports according to ESLint rules"
    echo "   3. Run 'npm run lint:imports' to verify fixes"
    echo "   âŒ STOPPED: Import order must pass before proceeding"
    exit 1
fi
echo "âœ… Format and Imports checking passed"

# Gate 4: Dead code detection
echo "ğŸ§¼ Gate 4: Dead code detection..."
npm run dead-code
if [ $? -ne 0 ]; then
    echo "âš ï¸  Dead code detected - Fix Plan:"
    echo "   1. Review unused exports in output above"
    echo "   2. Remove unused exports or add '_' prefix to unused parameters"
    echo "   3. Consider if code is needed for external API"
    echo "   4. Re-run 'npm run dead-code' to verify cleanup"
    echo "   âš ï¸  WARNING: Dead code should be cleaned up but not blocking"
    # Don't exit on dead code warnings as they're often false positives
fi
echo "âœ… Dead code detection completed"

# Gate 5: Complexity analysis
echo "ğŸ“Š Gate 5: Complexity analysis..."
npm run complexity
if [ $? -ne 0 ]; then
    echo "âš ï¸  Complexity issues detected - Fix Plan:"
    echo "   1. Review complexity-report.json for high-complexity functions"
    echo "   2. Consider refactoring complex functions (>10 complexity)"
    echo "   3. Break down large functions into smaller, focused ones"
    echo "   4. Re-run 'npm run complexity' to verify improvements"
    echo "   âš ï¸  WARNING: High complexity should be refactored but not blocking"
    # Don't exit on complexity as it's advisory
fi
echo "âœ… Complexity analysis completed"

# Final gate: Test coverage verification
echo "ğŸ§ª Final Gate: Test coverage verification..."
npm run verify-test-coverage
if [ $? -ne 0 ]; then
    echo "âŒ Test coverage verification failed - Fix Plan:"
    echo "   1. Check test coverage errors in output above"
    echo "   2. Add missing test files for protected source code"
    echo "   3. Improve test coverage to meet thresholds (80%+ statements)"
    echo "   4. Run 'npm run verify-test-coverage' to verify fixes"
    echo "   âŒ STOPPED: Test coverage must pass before committing"
    exit 1
fi
echo "âœ… Test coverage verification passed"

echo ""
echo "ğŸ‰ All pre-commit gates passed successfully!"
echo "âœ… Ready to commit with confidence!"
