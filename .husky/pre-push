
echo "ğŸš€ LEVEL 3: Running pre-push validation checks..."

# Get list of changed TypeScript files
CHANGED_TS_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '\.ts$' | wc -l)

if [ "$CHANGED_TS_FILES" -eq 0 ]; then
  echo "â„¹ï¸  No TypeScript files changed, skipping type-check"
  echo "âœ… LEVEL 3 pre-push checks passed!"
  exit 0
fi

echo "ğŸ”· Running lightweight type-check on changed files..."

# Create a temporary tsconfig for incremental checking
if [ ! -f "tsconfig.incremental.json" ]; then
  cat > tsconfig.incremental.json << EOF
{
  "extends": "./tsconfig.json",
  "compilerOptions": {
    "incremental": true,
    "tsBuildInfoFile": ".cache/tsbuildinfo"
  },
  "include": [
    "src/**/*.ts"
  ],
  "exclude": [
    "src/**/__tests__/**/*",
    "src/**/*.test.ts",
    "src/**/*.spec.ts",
    "src/chaos-testing/**/*",
    "tests/**/*"
  ]
}
EOF
fi

# Run type-check only on changed files (faster approach)
npx tsc --noEmit --project tsconfig.incremental.json || {
  echo "âŒ Type-check failed"
  echo "ğŸ’¡ Fix TypeScript errors before pushing"
  echo "   Run 'npx tsc --noEmit' to see full error details"
  echo ""
  echo "ğŸ”§ Quick fix suggestions:"
  echo "   - For unknown types: add proper type annotations"
  echo "   - For property access: use type guards or optional chaining"
  echo "   - For import errors: check module paths and exports"
  exit 1
}

echo "ğŸ§ª Running focused tests..."

# Run only unit tests for faster feedback
if command -v vitest >/dev/null 2>&1; then
  timeout 180 npm run test:unit || {
    echo "âŒ Unit tests failed"
    echo "ğŸ’¡ Fix failing tests before pushing"
    echo "   Run 'npm run test:unit' to see detailed results"
    exit 1
  }
else
  echo "âš ï¸  Vitest not available, skipping tests"
fi

echo "ğŸ”’ Running basic security check..."
npm audit --audit-level=high || {
  echo "âš ï¸  High/Critical security vulnerabilities found"
  echo "ğŸ’¡ Run 'npm audit fix' to resolve vulnerabilities"
  read -p "Continue anyway? (y/N): " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
}

echo "âœ… LEVEL 3 pre-push checks passed!"
echo "ğŸ‰ Ready to push changes"
echo ""
echo "ğŸ“Š Push Summary:"
echo "  â€¢ Type-check: âœ… Passed"
echo "  â€¢ Unit tests: âœ… Passed"
echo "  â€¢ Security: âœ… Passed (or accepted)"
echo "  â€¢ Files changed: $CHANGED_TS_FILES TypeScript files"