name: Schema Validation and Contract Testing

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

jobs:
  schema-validation:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for drift detection

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript compilation
        run: npm run build

      - name: Run schema drift detection
        run: |
          chmod +x scripts/schema-drift-detection.mjs
          node scripts/schema-drift-detection.mjs
        env:
          CI: true

      - name: Run contract tests
        run: npm test -- tests/integration/mcp-tool-contracts.test.ts

      - name: Run backward compatibility tests
        run: npm test -- tests/integration/backward-compatibility.test.ts

      - name: Run tenant isolation tests
        run: npm test -- tests/integration/tenant-isolation.test.ts

      - name: Upload schema drift report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: schema-drift-report-${{ matrix.node-version }}
          path: schema-drift-report.md
          retention-days: 30

      - name: Comment PR with schema drift results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            try {
              const report = fs.readFileSync('schema-drift-report.md', 'utf8');

              // Extract summary from report
              const lines = report.split('\n');
              const summaryLine = lines.find(line => line.includes('Breaking Changes:'));

              let comment = '## ðŸ” Schema Validation Results\n\n';

              if (summaryLine?.includes('Yes')) {
                comment += 'âŒ **Breaking changes detected!** Please review the full report below.\n\n';
              } else {
                comment += 'âœ… **No breaking changes detected.**\n\n';
              }

              comment += '### ðŸ“Š Summary\n\n';
              comment += summaryLine + '\n\n';

              // Add first few sections of the report
              const reportSections = report.split('## ');
              if (reportSections.length > 1) {
                comment += '### ðŸ“‹ Key Findings\n\n';
                for (let i = 1; i < Math.min(4, reportSections.length); i++) {
                  const section = reportSections[i];
                  if (section.includes('Issues') || section.includes('Warnings')) {
                    const sectionLines = section.split('\n').slice(0, 10);
                    comment += '#### ' + sectionLines[0] + '\n\n';
                    comment += sectionLines.slice(1).join('\n') + '\n\n';
                  }
                }
              }

              comment += '\nðŸ“„ [View Full Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})';

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });

            } catch (error) {
              console.log('Could not read schema drift report:', error.message);
            }

  integration-tests:
    runs-on: ubuntu-latest
    needs: schema-validation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Start test services
        run: |
          # Start Qdrant for testing
          docker run -d --name qdrant-test -p 6333:6333 qdrant/qdrant:latest
          sleep 10

      - name: Run integration tests
        run: npm test -- tests/integration/
        env:
          QDRANT_URL: http://localhost:6333
          QDRANT_COLLECTION_NAME: test-cortex-memory
          NODE_ENV: test

      - name: Cleanup test services
        if: always()
        run: docker stop qdrant-test && docker rm qdrant-test

  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        run: npm audit --audit-level moderate

      - name: Run code security analysis
        uses: github/super-linter@v4
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_TYPESCRIPT_ES: true
          VALIDATE_JAVASCRIPT_ES: true
          VALIDATE_JSON: true
          VALIDATE_YAML: true

  quality-gate:
    runs-on: ubuntu-latest
    needs: [schema-validation, integration-tests]
    if: always()

    steps:
      - name: Quality gate check
        run: |
          echo "ðŸ” Running quality gate checks..."

          # Check if any previous jobs failed
          if [ "${{ needs.schema-validation.result }}" != "success" ]; then
            echo "âŒ Schema validation failed"
            exit 1
          fi

          if [ "${{ needs.integration-tests.result }}" != "success" ]; then
            echo "âŒ Integration tests failed"
            exit 1
          fi

          echo "âœ… All quality gates passed"

      - name: Generate quality report
        run: |
          cat > quality-gate-report.md << EOF
          # Quality Gate Report

          ## Status: âœ… PASSED

          ### Checks Completed:
          - [x] Schema Validation
          - [x] Contract Testing
          - [x] Backward Compatibility
          - [x] Tenant Isolation Tests
          - [x] Integration Tests
          - [x] Security Scan

          ### Results:
          - Schema Validation: ${{ needs.schema-validation.result }}
          - Integration Tests: ${{ needs.integration-tests.result }}

          **Build is ready for deployment!**
          EOF

      - name: Upload quality report
        uses: actions/upload-artifact@v4
        with:
          name: quality-gate-report
          path: quality-gate-report.md
          retention-days: 30
