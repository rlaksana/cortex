# Cortex Memory MCP Alert Rules
#
# Comprehensive alerting for system health, performance, and business metrics
# Alert thresholds are configured for production environments

groups:
  - name: cortex-mcp-latency
    rules:
      # P95 latency alerts
      - alert: CortexHighLatencyP95
        expr: cortex_latency_milliseconds{quantile="0.95"} > 1000
        for: 5m
        labels:
          severity: warning
          service: cortex-mcp
          component: performance
        annotations:
          summary: "High P95 latency detected in Cortex MCP"
          description: "P95 latency for {{ $labels.operation }} is {{ $value }}ms (threshold: 1000ms) for 5 minutes"
          runbook_url: "https://docs.cortex.ai/troubleshooting/high-latency"
          impact: "Users experiencing slow response times"
          action: "Investigate performance bottlenecks and consider scaling"

      # P99 latency alerts
      - alert: CortexCriticalLatencyP99
        expr: cortex_latency_milliseconds{quantile="0.99"} > 2000
        for: 3m
        labels:
          severity: critical
          service: cortex-mcp
          component: performance
        annotations:
          summary: "Critical P99 latency detected in Cortex MCP"
          description: "P99 latency for {{ $labels.operation }} is {{ $value }}ms (threshold: 2000ms) for 3 minutes"
          runbook_url: "https://docs.cortex.ai/troubleshooting/critical-latency"
          impact: "Significant performance degradation affecting user experience"
          action: "Immediate investigation required, check for resource saturation"

  - name: cortex-mcp-errors
    rules:
      # Error rate alerts
      - alert: CortexHighErrorRate
        expr: |
          (
            sum(rate(cortex_errors_total{severity="critical"}[5m])) /
            sum(rate(cortex_operations_total[5m]))
          ) * 100 > 2
        for: 5m
        labels:
          severity: warning
          service: cortex-mcp
          component: reliability
        annotations:
          summary: "High error rate in Cortex MCP"
          description: "Error rate is {{ $value }}% (threshold: 2%) for 5 minutes"
          runbook_url: "https://docs.cortex.ai/troubleshooting/high-error-rate"
          impact: "Users experiencing failed operations"
          action: "Review logs and investigate root cause"

      # Critical error count
      - alert: CortexCriticalErrors
        expr: cortex_errors_total{severity="critical"} > 0
        for: 1m
        labels:
          severity: critical
          service: cortex-mcp
          component: reliability
        annotations:
          summary: "Critical errors detected in Cortex MCP"
          description: "{{ $value }} critical errors detected in the last minute"
          runbook_url: "https://docs.cortex.ai/troubleshooting/critical-errors"
          impact: "System may be in degraded state"
          action: "Immediate investigation and incident response"

  - name: cortex-mcp-resources
    rules:
      # Memory usage alerts
      - alert: CortexHighMemoryUsage
        expr: cortex_memory_bytes{type="process_resident_memory"} / 1024 / 1024 / 1024 > 4
        for: 5m
        labels:
          severity: warning
          service: cortex-mcp
          component: resources
        annotations:
          summary: "High memory usage in Cortex MCP"
          description: "Memory usage is {{ $value }}GB (threshold: 4GB) for 5 minutes"
          runbook_url: "https://docs.cortex.ai/troubleshooting/high-memory"
          impact: "Potential for performance degradation and OOM errors"
          action: "Investigate memory leaks and consider increasing resources"

      - alert: CortexCriticalMemoryUsage
        expr: cortex_memory_bytes{type="process_resident_memory"} / 1024 / 1024 / 1024 > 6
        for: 2m
        labels:
          severity: critical
          service: cortex-mcp
          component: resources
        annotations:
          summary: "Critical memory usage in Cortex MCP"
          description: "Memory usage is {{ $value }}GB (threshold: 6GB) for 2 minutes"
          runbook_url: "https://docs.cortex.ai/troubleshooting/critical-memory"
          impact: "High risk of out-of-memory errors"
          action: "Immediate action required, service restart may be necessary"

  - name: cortex-mcp-availability
    rules:
      # Service availability
      - alert: CortexServiceDown
        expr: up{job="cortex-mcp"} == 0
        for: 1m
        labels:
          severity: critical
          service: cortex-mcp
          component: availability
        annotations:
          summary: "Cortex MCP service is down"
          description: "Cortex MCP service has been down for more than 1 minute"
          runbook_url: "https://docs.cortex.ai/troubleshooting/service-down"
          impact: "Complete service outage"
          action: "Immediate investigation and service restart"

      # High QPS alert (possible DDoS or legitimate load)
      - alert: CortexUnusualHighQPS
        expr: cortex_qps{operation="total"} > 1000
        for: 2m
        labels:
          severity: warning
          service: cortex-mcp
          component: availability
        annotations:
          summary: "Unusually high QPS in Cortex MCP"
          description: "QPS is {{ $value }} ops/sec (threshold: 1000) for 2 minutes"
          runbook_url: "https://docs.cortex.ai/troubleshooting/high-qps"
          impact: "Service may be overwhelmed or under attack"
          action: "Investigate traffic source and consider rate limiting"

  - name: cortex-mcp-quality
    rules:
      # Low cache hit rate
      - alert: CortexLowCacheHitRate
        expr: cortex_quality_percent{metric="cache_hit_rate"} < 50
        for: 10m
        labels:
          severity: warning
          service: cortex-mcp
          component: performance
        annotations:
          summary: "Low cache hit rate in Cortex MCP"
          description: "Cache hit rate is {{ $value }}% (threshold: 50%) for 10 minutes"
          runbook_url: "https://docs.cortex.ai/troubleshooting/low-cache-hit"
          impact: "Reduced performance due to cache inefficiency"
          action: "Review cache configuration and usage patterns"

      # High deduplication rate (could indicate data quality issues)
      - alert: CortexHighDeduplicationRate
        expr: cortex_quality_percent{metric="dedupe_rate"} > 80
        for: 15m
        labels:
          severity: info
          service: cortex-mcp
          component: quality
        annotations:
          summary: "High deduplication rate in Cortex MCP"
          description: "Deduplication rate is {{ $value }}% (threshold: 80%) for 15 minutes"
          runbook_url: "https://docs.cortex.ai/monitoring/deduplication"
          impact: "High data duplication, potential storage optimization opportunity"
          action: "Review data ingestion patterns and quality"

  - name: cortex-mcp-business
    rules:
      # Low operation rate
      - alert: CortexLowOperationRate
        expr: rate(cortex_operations_total[5m]) < 1
        for: 15m
        labels:
          severity: info
          service: cortex-mcp
          component: business
        annotations:
          summary: "Low operation rate in Cortex MCP"
          description: "Operation rate is {{ $value }} ops/sec (threshold: 1) for 15 minutes"
          runbook_url: "https://docs.cortex.ai/monitoring/low-usage"
          impact: "May indicate system underutilization or issues"
          action: "Verify system is functioning and check expected usage patterns"

      # Service uptime
      - alert: CortexServiceUptime
        expr: cortex_uptime_seconds < 300
        for: 0m
        labels:
          severity: info
          service: cortex-mcp
          component: availability
        annotations:
          summary: "Cortex MCP service recently restarted"
          description: "Service uptime is {{ $value | humanizeDuration }}"
          runbook_url: "https://docs.cortex.ai/monitoring/uptime"
          impact: "Service recently restarted, monitoring for stability"
          action: "Monitor service stability and check restart logs"

  - name: cortex-mcp-circuit-breaker
    rules:
      # Circuit breaker state alerts (if circuit breaker metrics are available)
      - alert: CortexCircuitBreakerOpen
        expr: cortex_circuit_breaker_state{state="open"} == 1
        for: 2m
        labels:
          severity: critical
          service: cortex-mcp
          component: resilience
        annotations:
          summary: "Circuit breaker is open in Cortex MCP"
          description: "Circuit breaker for {{ $labels.service }} has been open for 2 minutes"
          runbook_url: "https://docs.cortex.ai/troubleshooting/circuit-breaker"
          impact: "Service is failing fast to protect the system"
          action: "Investigate root cause and service dependencies"

      - alert: CortexCircuitBreakerHalfOpen
        expr: cortex_circuit_breaker_state{state="half_open"} == 1
        for: 5m
        labels:
          severity: warning
          service: cortex-mcp
          component: resilience
        annotations:
          summary: "Circuit breaker is half-open in Cortex MCP"
          description: "Circuit breaker for {{ $labels.service }} has been half-open for 5 minutes"
          runbook_url: "https://docs.cortex.ai/troubleshooting/circuit-breaker"
          impact: "Service attempting recovery, may still be unstable"
          action: "Monitor recovery progress and check service health"

  - name: cortex-mcp-qdrant
    rules:
      # Qdrant connection issues
      - alert: CortexQdrantConnectionFailure
        expr: cortex_qdrant_connection_status == 0
        for: 1m
        labels:
          severity: critical
          service: cortex-mcp
          component: database
        annotations:
          summary: "Qdrant database connection failure"
          description: "Unable to connect to Qdrant database for 1 minute"
          runbook_url: "https://docs.cortex.ai/troubleshooting/qdrant-connection"
          impact: "Core functionality impaired, database unavailable"
          action: "Check Qdrant service status and network connectivity"

      # Qdrant high response time
      - alert: CortexQdrantHighResponseTime
        expr: cortex_qdrant_response_time_ms > 5000
        for: 3m
        labels:
          severity: warning
          service: cortex-mcp
          component: database
        annotations:
          summary: "High Qdrant database response time"
          description: "Qdrant response time is {{ $value }}ms (threshold: 5000ms) for 3 minutes"
          runbook_url: "https://docs.cortex.ai/troubleshooting/qdrant-performance"
          impact: "Slow database operations affecting overall performance"
          action: "Check Qdrant performance metrics and consider optimization"