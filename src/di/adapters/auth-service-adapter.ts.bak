/**
 * Auth Service Adapter
 *
 * Adapts the AuthService to implement the IAuthService interface.
 * Bridges interface gaps while maintaining backward compatibility.
 *
 * @author Cortex Team
 * @version 2.0.0
 * @since 2025
 */

import type { AuthService } from '../../services/auth/auth-service.js';
import type { IAuthService } from '../service-interfaces.js';

/**
 * Adapter for Auth service
 */
export class AuthServiceAdapter implements IAuthService {
  constructor(private authService: AuthService) {}

  /**
   * Authenticate user with token
   */
  async authenticate(token: string): Promise<boolean> {
    try {
      const payload = await this.authService.verifyAccessToken(token);
      return !!payload;
    } catch {
      return false;
    }
  }

  /**
   * Authorize user for resource and action
   */
 authorize(user: unknown, resource: string, action: string): Promise<boolean> {
    // Use the auth service's canAccessResource method
    return this.authService.canAccessResource(user, resource, action);
  }

  /**
   * Generate token for user
   */
 generateToken(user: unknown): Promise<string> {
    // Create a temporary session and generate access token
    const session = this.authService.createSession(user, '127.0.0.1', 'adapter');
    const scopes = this.authService.getUserScopes(user);
    return this.authService.generateAccessToken(user, session.id, scopes);
  }

  /**
   * Validate token and return payload
   */
  async validateToken(token: string): Promise<unknown> {
    try {
      return await this.authService.verifyAccessToken(token);
    } catch {
      return null;
    }
  }

  /**
   * Validate session
   */
  async validateSession(sessionId: string): Promise<boolean> {
    try {
      const session = await this.authService.getSession(sessionId);
      return !!session && session.isValid();
    } catch {
      return false;
    }
  }

  /**
   * Get user roles
   */
 getUserRoles(userId: string): Promise<string[]> {
    try {
      // Use existing method to get user info and extract roles
      const scopes = this.authService.getUserScopes({
        id: userId,
        username: '',
        email: '',
        password_hash: '',
        role: 'user' as unknown,
        is_active: true,
        created_at: '',
        updated_at: '',
      });
      return scopes || [];
    } catch {
      return [];
    }
  }

  /**
   * Get user allowed IPs
   */
 getUserAllowedIPs(userId: string): Promise<string[]> {
    try {
      // This would typically come from user configuration or security settings
      // For now, return default allowed IPs
      return ['127.0.0.1', '::1'];
    } catch {
      return [];
    }
  }

  /**
   * Get user time restrictions
   */
 getUserTimeRestrictions(userId: string): Promise<unknown> {
    try {
      // This would typically come from user configuration or security settings
      // For now, return no restrictions
      return {
        allowedHours: { start: 0, end: 24 },
        allowedDays: [0, 1, 2, 3, 4, 5, 6], // All days
        timezone: 'UTC',
      };
    } catch {
      return null;
    }
  }

  /**
   * Get user by ID
   */
 getUser(userId: string): Promise<unknown> {
    try {
      // This would typically query the user database
      // For now, return a basic user structure
      return {
        id: userId,
        username: `user_${userId}`,
        email: `user_${userId}@example.com`,
        role: 'user',
        isActive: true,
        createdAt: new Date().toISOString(),
      };
    } catch {
      return null;
    }
  }

  /**
   * Get user attributes
   */
 getUserAttributes(userId: string): Promise<Record<string, unknown>> {
    try {
      // This would typically query user attributes from the database
      // For now, return basic attributes
      return {
        userId,
        permissions: ['read', 'write'],
        preferences: {
          theme: 'light',
          notifications: true,
        },
      };
    } catch {
      return {};
    }
  }
}
