/**
 * Security Module Exports
 *
 * Comprehensive security system for MCP Cortex
 * P1-High T18: Security runtime checks and enforcement
 *
 * @author Cortex Security Team
 * @version 1.0.0
 * @since 2025-11-08
 */

// Import classes for internal use
import { AccessControlService } from './access-control-service.js';
import { DataSecurityService } from './data-security-service.js';
import { JSONSchemaValidatorService } from './json-schema-validator.js';

// Import types for internal use
import type { CompleteSecurityConfig } from './security-config-manager.js';
import { SecurityConfigManager } from './security-config-manager.js';
import { SecurityEnvironment } from './security-config-manager.js';
import { SecurityMonitoringService } from './security-monitoring-service.js';
import { SecurityRuntimeService } from './security-runtime-service.js';
import type { SecurityContext, SecurityViolation } from './security-types.js';

// Core Services - re-export
export { SecurityRuntimeService } from './security-runtime-service.js';
export { AccessControlService } from './access-control-service.js';
export { DataSecurityService } from './data-security-service.js';
export { SecurityMonitoringService } from './security-monitoring-service.js';
export { JSONSchemaValidatorService } from './json-schema-validator.js';
export { SecurityConfigManager } from './security-config-manager.js';

// Type imports from security-types (only those that actually exist)
export type {
  SecurityContext,
  SecurityViolation,
  ValidationResult,
  AccessControlDecision,
  SecurityEvent,
  SecurityMetrics,
  ThreatPattern,
  SecurityRule,
  SecurityAlert,
  UserBehaviorProfile,
  SecurityIncident,
  PIIDetection,
  SecretDetection,
  AnomalyDetection,
  SecurityConfiguration,
  SecurityPolicy,
  ComplianceRequirement,
  SecurityAuditLog,
  SecurityDashboard,
  SecurityReport,
} from './security-types.js';

// Import types from other modules
export type {
  SecurityRuntimeConfig,
  AccessControlConfig,
  DataSecurityConfig,
  SecurityMonitoringConfig,
  JSONSchemaValidationConfig,
  ConfigSource,
  ConfigValidationResult,
  ConfigChangeEvent,
  CompleteSecurityConfig,
  SecurityEnvironment,
} from './security-config-manager.js';

export type {
  Permission,
  Role,
  AccessPolicy,
  AttributeConstraint,
  AccessEvaluationContext,
} from './access-control-service.js';

export type { PIIPattern, SecretPattern, DataMaskingOptions } from './data-security-service.js';

export type { SchemaValidationResult, SecurityConstraint } from './json-schema-validator.js';

export type {
  UserBehaviorMetrics,
  AnomalyResult,
  ThreatIntelligence,
} from './security-monitoring-service.js';

// Decorators and Integration
export {
  Secure,
  RequirePermissions,
  RequireRoles,
  RateLimit,
  ValidateInput,
  FilterOutput,
  Audit,
  DataClassification,
  SecurityLevel as SecurityLevelDecorator,
  RequireMFA,
  AllowedIPs,
  TimeRestrictions,
  SecurityInterceptor,
  SecurityDecoratorUtils,
} from './security-decorators.js';

// Types and Interfaces are now consolidated above

// Enums
export { SecurityLevel, ThreatLevel } from './security-types.js';

export { DataClassificationLevel } from './data-security-service.js';

// SecurityEnvironment is already exported with config types above

// Constants
export const SECURITY_VERSION = '1.0.0';
export const SECURITY_MODULE_NAME = '@cortex/security';

// Default configurations
export const DEFAULT_SECURITY_CONFIG = {
  runtime: {
    enabled: true,
    strict_mode: false,
    fail_closed: false,
    max_input_size: 1000000,
    validation_timeout_ms: 5000,
    deep_validation_enabled: true,
    role_based_access: true,
    attribute_based_access: true,
    session_validation: true,
    pii_detection_enabled: true,
    data_masking_enabled: true,
    secret_detection_enabled: true,
    anomaly_detection: true,
    behavior_analysis: true,
    threat_intelligence: true,
    rate_limiting_enabled: true,
    adaptive_rate_limiting: false,
    auto_block_enabled: false,
    alert_threshold_violations: 5,
    quarantine_duration_minutes: 60,
  },
  accessControl: {
    enabled: true,
    rbac_enabled: true,
    abac_enabled: true,
    session_validation: true,
    multi_factor_auth: false,
    cache_permissions: true,
    cache_ttl_seconds: 300,
    fail_closed: false,
    audit_access: true,
    ip_whitelist_enabled: false,
    time_based_access: false,
    geo_fencing_enabled: false,
  },
  dataSecurity: {
    enabled: true,
    pii_detection_enabled: true,
    pii_masking_enabled: true,
    secret_detection_enabled: true,
    data_classification_enabled: true,
    encryption_at_rest_enabled: true,
    audit_data_access: true,
    quarantine_sensitive_data: true,
    data_retention_enabled: true,
    gdpr_compliance_enabled: false,
    hipaa_compliance_enabled: false,
    pci_compliance_enabled: false,
  },
  monitoring: {
    enabled: true,
    anomaly_detection: true,
    behavior_analysis: true,
    threat_intelligence: true,
    real_time_alerts: true,
    automated_response: false,
    learning_enabled: true,
    retention_days: 90,
    alert_thresholds: {
      violation_count_per_minute: 10,
      failed_auth_per_minute: 5,
      data_access_anomaly_score: 0.7,
      behavioral_anomaly_score: 0.8,
    },
    response_actions: {
      auto_block_ip: false,
      auto_block_user: false,
      auto_quarantine_session: false,
      require_mfa: false,
      escalate_to_admin: true,
    },
  },
  jsonSchemaValidation: {
    enabled: true,
    strict_mode: false,
    validation_timeout_ms: 1000,
    max_schema_depth: 10,
    max_array_length: 1000,
    max_string_length: 10000,
    max_object_properties: 100,
    custom_validators_enabled: true,
    security_constraints_enabled: true,
  },
};

// Utility functions
export const createSecurityContext = (partial: Partial<SecurityContext>): SecurityContext => ({
  id: partial.id || `security-ctx-${Date.now()}-${String(Math.random().toString(36).substr(2, 9))}`,
  userId: partial.userId,
  sessionId: partial.sessionId,
  ipAddress: partial.ipAddress,
  userAgent: partial.userAgent,
  operation: partial.operation,
  resource: partial.resource,
  timestamp: partial.timestamp || new Date(),
  requestId: partial.requestId,
  tenantId: partial.tenantId,
  roles: partial.roles || [],
  permissions: partial.permissions || [],
  metadata: partial.metadata || {},
});

export const validateSecurityContext = (
  context: SecurityContext
): { valid: boolean; errors: string[] } => {
  const errors: string[] = [];

  if (!context.id) {
    errors.push('Security context ID is required');
  }

  if (!context.timestamp) {
    errors.push('Security context timestamp is required');
  }

  if (context.userId && typeof context.userId !== 'string') {
    errors.push('User ID must be a string');
  }

  if (context.sessionId && typeof context.sessionId !== 'string') {
    errors.push('Session ID must be a string');
  }

  return {
    valid: errors.length === 0,
    errors,
  };
};

export const calculateSecurityScore = (violations: SecurityViolation[]): number => {
  if (violations.length === 0) return 100;

  const severityWeights = {
    low: 1,
    medium: 5,
    high: 15,
    critical: 30,
  };

  let totalPenalty = 0;
  for (const violation of violations) {
    totalPenalty += severityWeights[violation.severity] || 1;
  }

  return Math.max(0, 100 - totalPenalty);
};

export const determineRiskLevel = (score: number): 'low' | 'medium' | 'high' | 'critical' => {
  if (score >= 80) return 'low';
  if (score >= 60) return 'medium';
  if (score >= 40) return 'high';
  return 'critical';
};

// Security module factory function
export const createSecurityModule = (config: Partial<CompleteSecurityConfig> = {}) => {
  const mergedConfig = {
    runtime: { ...DEFAULT_SECURITY_CONFIG.runtime, ...config.runtime },
    accessControl: { ...DEFAULT_SECURITY_CONFIG.accessControl, ...config.accessControl },
    dataSecurity: { ...DEFAULT_SECURITY_CONFIG.dataSecurity, ...config.dataSecurity },
    monitoring: { ...DEFAULT_SECURITY_CONFIG.monitoring, ...config.monitoring },
    jsonSchemaValidation: {
      ...DEFAULT_SECURITY_CONFIG.jsonSchemaValidation,
      ...config.jsonSchemaValidation,
    },
    environment: config.environment || SecurityEnvironment.DEVELOPMENT,
    version: SECURITY_VERSION,
    lastUpdated: new Date(),
    sources: config.sources || {},
  };

  return {
    config: mergedConfig,
    version: SECURITY_VERSION,
    createService: (dependencies: unknown) => {
      return {
        runtime: new SecurityRuntimeService(
          dependencies.logger,
          dependencies.authService,
          dependencies.auditService,
          mergedConfig.runtime
        ),
        accessControl: new AccessControlService(
          dependencies.logger,
          dependencies.authService,
          mergedConfig.accessControl
        ),
        dataSecurity: new DataSecurityService(dependencies.logger, mergedConfig.dataSecurity),
        monitoring: new SecurityMonitoringService(
          dependencies.logger,
          dependencies.auditService,
          mergedConfig.monitoring
        ),
        schemaValidator: new JSONSchemaValidatorService(
          dependencies.logger,
          mergedConfig.jsonSchemaValidation
        ),
        configManager: new SecurityConfigManager(dependencies.logger),
      };
    },
  };
};
